<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Registro Orario Settimanale</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f8f8f8; }
    header { background: #0073b7; color: white; padding: 10px; text-align: center; font-size: 18px; font-weight: bold; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; background: #ddd; padding: 10px; }
    select { padding: 5px; font-size: 14px; }
    .settimane { display: flex; flex-wrap: wrap; gap: 3px; }
    .settimana { width: 40px; text-align: center; padding: 5px; background: white; border: 1px solid #aaa; cursor: pointer; border-radius: 5px; }
    .settimana.active { background: #0073b7; color: white; font-weight: bold; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 5px; font-size: 12px; vertical-align: top; }
    .orari { width: 60px; font-weight: bold; background: #f9f9f9; }
    td:hover { background: #eaf5ff; cursor: pointer; }
    .lesson { background: #0073b7; color: white; border-radius: 5px; padding: 3px; font-size: 11px; }
    .popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
    .popup-content { background: white; padding: 15px; border-radius: 8px; width: 320px; max-height: 85vh; overflow-y: auto; }
    .popup-content h3 { margin-top: 0; }
    .btn { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; margin: 3px; }
    .btn-primary { background: #0073b7; color: white; }
    .btn-danger { background: #d9534f; color: white; }
    .btn-success { background: #5cb85c; color: white; }
    #listaStudenti div { font-size: 12px; margin: 3px 0; display: flex; justify-content: space-between; }
    #listaStudenti select { font-size: 12px; }
  </style>
</head>
<body>
  <header>Registro - Orario Settimanale</header>

  <div class="top-bar">
    <div>
      Classe: 
      <select id="classeSelect">
        <option value="1">1ª Superiore</option>
        <option value="2">2ª Superiore</option>
      </select>
    </div>
    <div class="settimane" id="listaSettimane"></div>
  </div>

  <div id="registro-container"></div>

  <!-- Popup Lezione -->
  <div class="popup" id="popupLezione">
    <div class="popup-content">
      <h3>Crea Lezione</h3>
      <label>Materia:
        <select id="materiaSelect">
          <option>Italiano</option>
          <option>Matematica</option>
          <option>Inglese</option>
          <option>Storia</option>
          <option>Geografia</option>
          <option>Scienze</option>
          <option>Arte</option>
          <option>Musica</option>
          <option>Disegno</option>
          <option>Informatica</option>
          <option>Ginnastica</option>
          <option>Accoglienza e Orientamento</option>
          <option>Recupero e Approfondimento</option>
          <option>Sicurezza</option>
        </select>
      </label><br><br>
      <label>Docente:
        <select id="docenteSelect">
          <option>Enrico Dematteis</option>
          <option>Pikky Pomodoro</option>
          <option>Pippy Ananas</option>
          <option>Spinaci Verdi</option>
          <option>Alessia Dematteis</option>
          <option>Davide Frollino</option>
          <option>Insalata Russa</option>
        </select>
      </label><br><br>
      <label>Ora inizio: <input type="time" id="oraInizio"></label><br><br>
      <label>Ora fine: <input type="time" id="oraFine"></label><br><br>
      <button class="btn btn-primary" onclick="salvaLezione()">Crea</button>
      <button class="btn btn-danger" onclick="chiudiPopupLezione()">Chiudi</button>
    </div>
  </div>

  <!-- Popup Appello -->
  <div class="popup" id="popupAppello">
    <div class="popup-content">
      <h3>Appello</h3>
      <div id="listaStudenti"></div>
      <button class="btn btn-success" onclick="salvaAppello()">Completa</button>
      <button class="btn btn-primary" onclick="sostituisciLezione()">Sostituzione</button>
      <button class="btn btn-danger" onclick="chiudiPopupAppello()">Chiudi</button>
    </div>
  </div>

  <script>
    let registro = JSON.parse(localStorage.getItem("registro")) || {};
    let settimanaCorrente = null;
    let classeCorrente = "1";
    let cellaCorrente = null;

    const studenti1 = ["DEMATTEIS STELLINA","DEMATTEIS PANDINO","BENUA TARTARUGA","BENUA YUCKY","BENUA LOLLO","DEMATTEIS BRICIOLA","DEMATTEIS FLUFFY","DEMATTEIS TINA","BENUA GRIGETTA","DEMATTEIS LUNA","BENUA LUNA","DEMATTEIS KENDY","DEMATTEIS PAPERO","DEMATTEIS ATTIGLIO","DEMATTEIS CURT","BENUA BUNNY"];
    const studenti2 = ["DEMATTEIS CANE","BENUA CANE","DEMATTEIS MICIAN","TEMPERINI CICCIOBELLO","CAROTINI MAICOL","TEMPERINI CATTIVO","CAROTINI BAMBOLA","ROSETTI ROBOTTINA"];

    function getKey(giorno, ora) {
      return settimanaCorrente + "_" + classeCorrente + "_" + giorno + "_" + ora;
    }

    function generaSettimane() {
      let lista = document.getElementById("listaSettimane");
      lista.innerHTML = "";
      for (let i=35; i<=52; i++) aggiungiSettimana(i, lista);
      for (let i=1; i<=34; i++) aggiungiSettimana(i, lista);
    }

    function aggiungiSettimana(num, lista) {
      let div = document.createElement("div");
      div.className = "settimana";
      div.textContent = num;
      div.onclick = () => selezionaSettimana(div, num);
      lista.appendChild(div);
    }

    function selezionaSettimana(el, num) {
      document.querySelectorAll(".settimana").forEach(s=>s.classList.remove("active"));
      el.classList.add("active");
      settimanaCorrente = num;
      generaTabella();
    }

    function generaTabella() {
      let giorni = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
      let html = "<table><tr><th class='orari'></th>";
      giorni.forEach(g => html += `<th>${g}</th>`);
      html+="</tr>";

      for (let h=7; h<=23; h++) {
        html += `<tr><td class='orari'>${h}:00</td>`;
        for (let g=0; g<7; g++) {
          let key = getKey(g,h);
          let lezione = registro[key];
          if (lezione === "skip") continue;

          if (lezione && lezione.lezione) {
            let start = parseInt(lezione.lezione.oraInizio.split(":")[0]);
            let end = parseInt(lezione.lezione.oraFine.split(":")[0]);
            let durata = end - start;
            html += `<td rowspan="${durata}" data-giorno='${g}' data-ora='${h}' onclick='apriLezione(this)'>`;
            html += `<div class='lesson'><b>${lezione.lezione.materia}</b><br>${lezione.lezione.docente}<br>${lezione.lezione.oraInizio}-${lezione.lezione.oraFine}</div>`;
            html += "</td>";
          } else {
            html += `<td data-giorno='${g}' data-ora='${h}' onclick='apriLezione(this)'></td>`;
          }
        }
        html+="</tr>";
      }
      html+="</table>";
      document.getElementById("registro-container").innerHTML = html;
    }

    function apriLezione(cell) {
      cellaCorrente = cell;
      const giorno=cell.dataset.giorno;
      const ora=cell.dataset.ora;
      const key=getKey(giorno,ora);

      if (!registro[key] || !registro[key].lezione) {
        document.getElementById("popupLezione").style.display="flex";
      } else {
        apriAppello(key);
      }
    }

    function salvaLezione() {
      const materia=document.getElementById("materiaSelect").value;
      const docente=document.getElementById("docenteSelect").value;
      const oraInizio=document.getElementById("oraInizio").value;
      const oraFine=document.getElementById("oraFine").value;

      if (!materia || !docente || !oraInizio || !oraFine) {
        alert("Compila tutti i campi!");
        return;
      }

      const giorno=cellaCorrente.dataset.giorno;
      const ora=cellaCorrente.dataset.ora;
      const key=getKey(giorno,ora);

      registro[key] = { lezione:{materia,docente,oraInizio,oraFine}, appello:{} };

      let start=parseInt(oraInizio.split(":")[0]);
      let end=parseInt(oraFine.split(":")[0]);
      for (let h=start+1; h<end; h++) {
        registro[getKey(giorno,h)]="skip";
      }

      localStorage.setItem("registro",JSON.stringify(registro));
      chiudiPopupLezione();
      generaTabella();
    }

    function chiudiPopupLezione() {
      document.getElementById("popupLezione").style.display="none";
    }

    function apriAppello(key) {
      let studenti = classeCorrente==="1" ? studenti1 : studenti2;
      let lista=document.getElementById("listaStudenti");
      lista.innerHTML="";
      studenti.forEach(nome=>{
        let div=document.createElement("div");
        div.textContent=nome;
        let sel=document.createElement("select");
        ["","Presente","Assente"].forEach(opt=>{
          let o=document.createElement("option");
          o.value=opt; o.textContent=opt;
          sel.appendChild(o);
        });
        if (registro[key].appello[nome]) sel.value=registro[key].appello[nome];
        div.appendChild(sel);
        lista.appendChild(div);
      });
      document.getElementById("popupAppello").dataset.key=key;
      document.getElementById("popupAppello").style.display="flex";
    }

    function salvaAppello() {
      let key=document.getElementById("popupAppello").dataset.key;
      let studenti = classeCorrente==="1" ? studenti1 : studenti2;
      registro[key].appello={};
      let divs=document.querySelectorAll("#listaStudenti div");
      divs.forEach(d=>{
        let nome=d.firstChild.textContent;
        let stato=d.querySelector("select").value;
        registro[key].appello[nome]=stato;
      });
      localStorage.setItem("registro",JSON.stringify(registro));
      chiudiPopupAppello();
    }

    function sostituisciLezione() {
      let key=document.getElementById("popupAppello").dataset.key;
      delete registro[key];
      localStorage.setItem("registro",JSON.stringify(registro));
      chiudiPopupAppello();
      generaTabella();
    }

    function chiudiPopupAppello() {
      document.getElementById("popupAppello").style.display="none";
    }

    generaSettimane();
    document.querySelector(".settimana").click();
  </script>
</body>
</html>
